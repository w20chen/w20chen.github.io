---
layout:     post
title:      Brainf*ck
subtitle:   programming
date:       2022-10-22
author:     Chen
header-img: img/needle.png
catalog:    false
tags:
    - CS
---

>虽然周末有很多作业没写，但是仍不愿开始写。    

今天用 C/C++ 写了一个 Brainf\*uch 编译器，主要是受 ICS-PA 的 YEMU 的启发。     
**This is just a toy.** 程序的逻辑很简单。     
Github 上能找到一些有趣的测试用例，除了 `hello world`，还有 `打印Hanoi`等等。   
<br>
Brainf\*ck 本身不仅仅是一个玩具，它是用来论证**图灵完备**（Turing Completeness）的。    
`data pointer` 模拟了计算机对数据的访问，`+` 和 `-` 操作模拟了对数据的修改。Brainf\*uck 不能随机访问内存，而是使用 `<` 和 `>` 控制 `data pointer` 访存。        
在这个基础上，只需要添加一个跳转指令就可以了，Brainf\*ck 使用 `[ ]` 实现一个循环体。         
事实上，可以用一个 `^` 表示跳转指令：让 `pc` 向前跳转 `data pointer` 所指向的值那么长的距离（若为负数则往后跳转）。这样除了输入输出外，只需要 5 条指令。      
据说，可以使用更少的指令实现图灵完备。     
模拟内存的数组 和 存储程序的字符串，若长度不够，可自行修改长度。    

<a href="https://www.tutorialspoint.com/execute_brainfk_online.php">这里</a>是一个在线的编译器，它和我实现的程序逻辑是完全一样的。     

```cpp
#include <cstdio>

#include <cstdint>

#include <cstdlib>

#include <cstring>

#include <stack>

#include <assert.h>



#define MEMSIZE (300000 + 128)

#define PROG_LEN 300000


typedef int8_t dtype;

char program[PROG_LEN];

dtype* data_ptr;
dtype* mem;


dtype input() {
    char ch;
    if (scanf("%c", &ch)) {
        return ch;
    }
    return 0;
}

void output(dtype* p) {
    printf("%c", *p);
}


int L[PROG_LEN];
int R[PROG_LEN];
#define Left(x) L[x]

#define Right(x) R[x]


void parser(char* str) {
    std::stack<int> stk;
    for (int i = 0; str[i]; i++) {
        if (str[i] == '[') {
            stk.push(i);
        }
        else if (str[i] == ']') {
            assert(!stk.empty());
            R[stk.top()] = i;
            L[i] = stk.top();
            stk.pop();
        }
    }
    // maybe unnecessary
    if (!stk.empty()) {
        printf("\e[1;31munbalanced brackets\n\e[0m");
        exit(1);
    }
}



void init() {
    mem = (dtype*)malloc(sizeof(dtype) * MEMSIZE);
    if (!mem) {
        printf("\e[1;31mcannot allocate memory\n\e[0m");
        exit(1);    
    }

    // set all memory as zero
    memset(mem, 0, sizeof(dtype) * MEMSIZE);
    
    data_ptr = mem + 128;
    parser(program);
}


void execute(char* str) {
    for (int pc = 0; str[pc]; pc++) {
        switch (str[pc]) {
        case '>':
            data_ptr++;
            break;
        case '<':
            data_ptr--;
            break;
        case '+':
            (*data_ptr)++;
            break;
        case '-':
            (*data_ptr)--;
            break;
        case '.':
            output(data_ptr);
            break;
        case ',':
            *data_ptr = input();
            break;
        case '[':
            if (*data_ptr == 0) {
                pc = Right(pc);
            }
            break;
        case ']':
            if (*data_ptr != 0) {
                pc = Left(pc);
            }
            break;
        case '\n':
            break;
        default:
            // comment
            break;
        }
    }
}



int main(int argc, char ** argv) {
    assert(argc > 1);

    FILE* fp = fopen(argv[1], "r");
    if(!fp) {
        printf("\e[1;31mcannot find file %s\n\e[0m", argv[1]);
        exit(1);
    }

    int cnt = -1;
    do {
        program[++cnt] = fgetc(fp);
    } 
    while(program[cnt] != EOF);
    program[cnt] = 0;
    fclose(fp);

    init();

    execute(program);
    
    return 0;
}
```

猜猜这是什么？
```cmd
                                >    
                               + +    
                              +   +    
                             [ < + +    
                            +       +    
                           + +     + +    
                          >   -   ]   >    
                         + + + + + + + +    
                        [               >    
                       + +             + +    
                      <   -           ]   >    
                     > + + >         > > + >    
                    >       >       +       <    
                   < <     < <     < <     < <    
                  <   [   -   [   -   >   +   <    
                 ] > [ - < + > > > . < < ] > > >    
                [                               [    
               - >                             + +    
              +   +                           +   +    
             + + [ >                         + + + +    
            <       -                       ]       >    
           . <     < [                     - >     + <    
          ]   +   >   [                   -   >   +   +    
         + + + + + + + +                 < < + > ] > . [    
        -               ]               >               ]    
       ] +             < <             < [             - [    
      -   >           +   <           ]   +           >   [    
     - < + >         > > - [         - > + <         ] + + >    
    [       -       <       -       >       ]       <       <    
   < ]     < <     < <     ] +     + +     + +     + +     + +    
  +   .   +   +   +   .   [   -   ]   <   ]   +   +   +   +   +      
```

试试这个：
```cmd
>++++++++++[<++++++++++>-]<->>>>>+++[>+++>+++<<-]<<<<+<[>[>+
>+<<-]>>[-<<+>>]++++>+<[-<->]<[[-]>>-<<]>>[[-]<<+>>]<<[[-]>>
>>>>[[-]<++++++++++<->>]<-[>+>+<<-]>[<+>-]+>[[-]<->]<<<<<<<<
<->>]<[>+>+<<-]>>[-<<+>>]+>+<[-<->]<[[-]>>-<<]>>[[-]<<+>>]<<
<[>>+>+<<<-]>>>[-<<<+>>>]++>+<[-<->]<[[-]>>-<<]>>[[-]<<+>>]<
<[>+<[-]]<[>>+<<[-]]>>[<<+>>[-]]<<<[>>+>+<<<-]>>>[-<<<+>>>]+
+++>+<[-<->]<[[-]>>-<<]>>[[-]<<+>>]<<[>+<[-]]<[>>+<<[-]]>>[<
<+>>[-]]<<[[-]>>>++++++++[>>++++++<<-]>[<++++++++[>++++++<-]
>.<++++++++[>------<-]>[<<+>>-]]>.<<++++++++[>>------<<-]<[-
>>+<<]<++++++++[<++++>-]<.>+++++++[>+++++++++<-]>+++.<+++++[
>+++++++++<-]>.+++++..--------.-------.++++++++++++++>>[>>>+
>+<<<<-]>>>>[-<<<<+>>>>]>+<[-<->]<[[-]>>-<<]>>[[-]<<+>>]<<<<
[>>>+>+<<<<-]>>>>[-<<<<+>>>>]+>+<[-<->]<[[-]>>-<<]>>[[-]<<+>
>]<<<[>>+<<[-]]>[>+<[-]]++>>+<[-<->]<[[-]>>-<<]>>[[-]<<+>>]<
+<[[-]>-<]>[<<<<<<<.>>>>>>>[-]]<<<<<<<<<.>>----.---------.<<
.>>----.+++..+++++++++++++.[-]<<[-]]<[>+>+<<-]>>[-<<+>>]+>+<
[-<->]<[[-]>>-<<]>>[[-]<<+>>]<<<[>>+>+<<<-]>>>[-<<<+>>>]++++
>+<[-<->]<[[-]>>-<<]>>[[-]<<+>>]<<[>+<[-]]<[>>+<<[-]]>>[<<+>
>[-]]<<[[-]>++++++++[<++++>-]<.>++++++++++[>+++++++++++<-]>+
.-.<<.>>++++++.------------.---.<<.>++++++[>+++<-]>.<++++++[
>----<-]>++.+++++++++++..[-]<<[-]++++++++++.[-]]<[>+>+<<-]>>
[-<<+>>]+++>+<[-<->]<[[-]>>-<<]>>[[-]<<+>>]<<[[-]++++++++++.
>+++++++++[>+++++++++<-]>+++.+++++++++++++.++++++++++.------
.<++++++++[>>++++<<-]>>.<++++++++++.-.---------.>.<-.+++++++
++++.++++++++.---------.>.<-------------.+++++++++++++.-----
-----.>.<++++++++++++.---------------.<+++[>++++++<-]>..>.<-
---------.+++++++++++.>.<<+++[>------<-]>-.+++++++++++++++++
.---.++++++.-------.----------.[-]>[-]<<<.[-]]<[>+>+<<-]>>[-
<<+>>]++++>+<[-<->]<[[-]>>-<<]>>[[-]<<+>>]<<[[-]++++++++++.[
-]<[-]>]<+<]
```